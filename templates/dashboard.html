{% extends "base.html" %}
{% block content %}

<style>
/* =========================================================
   GLOBAL LAYOUT
========================================================= */
body {
    background: #f7f7fb;
    font-family: 'Inter', sans-serif;
    color: #222;
}

.navbar {
    width: 100%;
    padding: 18px 40px;
    background: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 1px 4px rgba(0,0,0,0.07);
    position: sticky;
    top: 0;
    z-index: 10;
}
.nav-left { font-size: 22px; font-weight: 700; color: #6A4CFF; }
.nav-links a {
    margin-left: 25px;
    text-decoration: none;
    color: #333;
    font-weight: 500;
}
.nav-links a:hover { color: #6A4CFF; }

/* =========================================================
   INFO ICONS + MODAL
========================================================= */
.info-icon {
    font-size: 18px;
    color: #6A4CFF;
    cursor: pointer;
}
.info-icon:hover { opacity: 0.7; }

.info-wrap {
    display: inline-flex;
    align-items: center;
}

.tooltip-box {
    visibility: hidden;
    opacity: 0;
    position: absolute;
    background: #ffffff;
    color: #333;
    border: 1px solid #ddd;
    padding: 8px 12px;
    font-size: 13px;
    border-radius: 6px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    white-space: nowrap;
    transition: opacity 0.2s ease;
    transform: translateY(-5px);
    z-index: 30;
}
.info-wrap:hover .tooltip-box {
    visibility: visible;
    opacity: 1;
}

.info-modal-bg {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.55);
    justify-content: center;
    align-items: center;
    z-index: 99999;
}
.info-modal {
    background: white;
    width: 90%;
    max-width: 420px;
    padding: 25px;
    border-radius: 14px;
    box-shadow: 0 6px 30px rgba(0,0,0,0.2);
}
.info-modal h3 {
    font-size: 20px;
    color: #6A4CFF;
}
.modal-close {
    margin-top: 18px;
    background: #6A4CFF;
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    cursor: pointer;
    width: 100%;
    font-weight: 600;
}

/* =========================================================
   HERO
========================================================= */
.dashboard-hero {
    background: linear-gradient(135deg, #7A5BFF, #6A4CFF);
    padding: 60px 30px;
    border-radius: 18px;
    text-align: center;
    margin-bottom: 35px;
    color: white;
}
.dash-title { font-size: 52px; font-weight: 800; }
.dash-subtitle { font-size: 20px; opacity: 0.95; }

/* =========================================================
   PAGE WRAPPER
========================================================= */
.page-wrapper {
    max-width: 1300px;
    margin: auto;
    display: flex;
    gap: 25px;
}
.dashboard-container {
    width: 100%;
    max-width: 900px;
}
.card {
    background: white;
    border-radius: 14px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: 0 3px 8px rgba(0,0,0,0.08);
}
.section-title {
    font-size: 22px;
    font-weight: 600;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* =========================================================
   SCORE CIRCLE
========================================================= */
.score-circle {
    width: 160px; height: 160px;
    border-radius: 50%;
    background: conic-gradient(#ddd 0deg, #ddd 360deg);
    display: flex; justify-content: center; align-items: center;
}
.score-circle-inner {
    width: 120px; height: 120px;
    background: white;
    border-radius: 50%;
    display: flex; justify-content: center; align-items: center;
    font-size: 36px; font-weight: 700;
}

/* =========================================================
   PROGRESS BARS
========================================================= */
.progress-label {
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 5px;
}
.progress-bar {
    width: 100%; height: 16px;
    background: #eee;
    border-radius: 10px;
    overflow: hidden;
    margin-bottom: 12px;
}
.progress-fill {
    height: 100%;
    width: 0%;
    background: #6A4CFF;
    transition: width 1.2s ease;
}

/* =========================================================
   AUDIT + TIPS
========================================================= */
.audit-box-modern {
    background: #fafaff;
    border: 1px solid #e5e2ff;
    padding: 20px;
    border-radius: 12px;
    font-size: 15px;
}
.audit-entry { margin-bottom: 8px; }

.tips-modern {
    background: #fdfcff;
    border: 1px solid #ebe7ff;
    padding: 20px;
    border-radius: 12px;
}
.tips-modern li { margin-bottom: 8px; }

/* =========================================================
   UPGRADE MODAL (PDF BLOCKED FOR FREE USERS)
========================================================= */
#upgradeModalBG {
    display:none;
    position:fixed;
    top:0;left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.55);
    justify-content:center;
    align-items:center;
    z-index:999999;
}
#upgradeModal {
    background:white;
    width:90%;
    max-width:440px;
    padding:25px;
    border-radius:14px;
    text-align:center;
}
#upgradeModal h2 { color:#6A4CFF; }
.upgradeBtn {
    margin-top:20px;
    padding:12px 18px;
    background:#6A4CFF;
    color:white;
    border:none;
    border-radius:8px;
    font-weight:700;
    cursor:pointer;
}
</style>

<!-- ==================== INFO MODAL HTML ==================== -->
<div id="modalBG" class="info-modal-bg">
    <div class="info-modal">
        <h3 id="modalTitle"></h3>
        <p id="modalText"></p>
        <button class="modal-close" onclick="closeInfoModal()">Got it</button>
    </div>
</div>

<!-- ==================== PDF UPGRADE MODAL ==================== -->
<div id="upgradeModalBG">
    <div id="upgradeModal">
        <h2>Upgrade Required</h2>
        <p>PDF reports are available only to Pro members.<br>Upgrade now to unlock unlimited reports!</p>
        <button class="upgradeBtn" onclick="window.location.href='/pricing'">Upgrade to Pro</button>
    </div>
</div>


<!-- NAV -->
<div class="navbar">
    <div class="nav-left">SEO Booster Pro</div>
    <div class="nav-links">
        <a href="/dashboard">Dashboard</a>
        <a href="/settings">Settings</a>
        <a href="/logout">Logout</a>
    </div>
</div>


<div class="dashboard-hero">
    <h1 class="dash-title">SEO Dashboard</h1>
    <p class="dash-subtitle">Instant AI-powered insights to improve your rankings</p>
</div>

<div class="page-wrapper">
    <div class="dashboard-container">

        <!-- ANALYZER -->
        <div class="card">
            <div class="section-title">
                üîç SEO Analyzer
                <span class="info-wrap">
                    <span class="info-icon" onclick="openInfoModal('Analyzer','Enter a URL and we scan the content, structure, and technical setup to find quick SEO wins.')">‚ìò</span>
                    <div class="tooltip-box">What this does</div>
                </span>
            </div>

            <div style="display:flex; gap:10px; margin-bottom:12px;">
                <input id="urlInput" type="url" placeholder="Your website URL‚Ä¶" style="flex:1;padding:12px;border-radius:8px;border:1px solid #ccc;">
                <button id="analyzeBtn" style="background:#6A4CFF;color:white;padding:12px 18px;border-radius:8px;border:none;">Analyze</button>
            </div>

            <input id="keywordInput" type="text" placeholder="Keyword (optional)" style="width:100%;padding:12px;border-radius:8px;border:1px solid #ccc;margin-bottom:12px;">
            <input id="compInput" type="url" placeholder="Competitor URL (optional)" style="width:100%;padding:12px;border-radius:8px;border:1px solid #ccc;">
        </div>

        <button id="pdfBtn" style="margin-top:12px;background:#2D8CFF;color:white;padding:12px 18px;border-radius:8px;border:none;display:none;">Download PDF Report</button>

        <!-- RESULTS -->
        <div id="resultsArea" style="display:none;">

            <!-- SCORE -->
            <div class="card">
                <div class="section-title">
                    üìà Your Site Score
                    <span class="info-wrap">
                        <span class="info-icon" onclick="openInfoModal('Your Score','Higher scores mean Google can understand and rank your page more easily.')">‚ìò</span>
                        <div class="tooltip-box">What this score is</div>
                    </span>
                </div>

                <div class="score-wrapper">
                    <div id="scoreCircle" class="score-circle">
                        <div id="scoreInner" class="score-circle-inner">0</div>
                    </div>
                </div>
            </div>

            <!-- BREAKDOWN -->
            <div class="card">
                <div class="section-title">üìä Detailed Breakdown</div>

                <div class="progress-label">
                    Content Quality
                    <span class="info-wrap">
                        <span class="info-icon" onclick="openInfoModal('Content Quality','Checks how detailed and helpful your page content is.')">‚ìò</span>
                        <div class="tooltip-box">Your writing</div>
                    </span>
                </div>
                <div class="progress-bar"><div id="pb-content" class="progress-fill"></div></div>

                <div class="progress-label">
                    Keyword Relevance
                    <span class="info-wrap">
                        <span class="info-icon" onclick="openInfoModal('Keyword Relevance','Shows how well your page fits the keyword you entered.')">‚ìò</span>
                        <div class="tooltip-box">Keyword match</div>
                    </span>
                </div>
                <div class="progress-bar"><div id="pb-keyword" class="progress-fill"></div></div>

                <div class="progress-label">
                    Technical Health
                    <span class="info-wrap">
                        <span class="info-icon" onclick="openInfoModal('Technical Health','Checks tags, mobile setup, alt text, and more.')">‚ìò</span>
                        <div class="tooltip-box">Tech health</div>
                    </span>
                </div>
                <div class="progress-bar"><div id="pb-tech" class="progress-fill"></div></div>

                <div class="progress-label">
                    On-Page Structure
                    <span class="info-wrap">
                        <span class="info-icon" onclick="openInfoModal('On-Page Structure','Looks at headings and page organization.')">‚ìò</span>
                        <div class="tooltip-box">Layout</div>
                    </span>
                </div>
                <div class="progress-bar"><div id="pb-onpage" class="progress-fill"></div></div>

                <div class="progress-label">
                    Link Health
                    <span class="info-wrap">
                        <span class="info-icon" onclick="openInfoModal('Link Health','Checks broken links.')">‚ìò</span>
                        <div class="tooltip-box">Links</div>
                    </span>
                </div>
                <div class="progress-bar"><div id="pb-links" class="progress-fill"></div></div>
            </div>

            <!-- AUDIT -->
            <div class="card">
                <div class="section-title">üßπ Site Audit</div>
                <div class="audit-box-modern" id="auditBox"></div>
            </div>

            <!-- TIPS -->
            <div class="card">
                <div class="section-title">üí° Optimization Tips</div>
                <div class="tips-modern"><ul id="tipsBox"></ul></div>
            </div>

        </div>
    </div>
</div>

<!-- ============ JAVASCRIPT ============ -->
<script>
function openInfoModal(title, text) {
    document.getElementById("modalTitle").innerText = title;
    document.getElementById("modalText").innerText = text;
    document.getElementById("modalBG").style.display = "flex";
}
function closeInfoModal() {
    document.getElementById("modalBG").style.display = "none";
}

document.getElementById("analyzeBtn").onclick = async function () {
    let url = document.getElementById("urlInput").value.trim();
    if (!url) return alert("Enter a valid URL.");

    let keyword = document.getElementById("keywordInput").value;
    let competitor = document.getElementById("compInput").value;

    const btn = document.getElementById("analyzeBtn");
    btn.disabled = true;
    btn.style.opacity = "0.6";
    btn.innerHTML = "Analyzing...";

    const res = await fetch("/scan", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ url, keyword, competitor })
    });

    const data = await res.json();

    btn.innerHTML = "Analyze";
    btn.style.opacity = "1";
    btn.disabled = false;

    if (data.error === "limit") {
        alert("You've reached your free scan limit. Upgrade to Pro.");
        return;
    }

    document.getElementById("resultsArea").style.display = "block";

    let finalScore = data.score;
    let inner = document.getElementById("scoreInner");
    let circle = document.getElementById("scoreCircle");
    let current = 0;

    let color = "#6A4CFF";
    if (finalScore >= 80) color = "#09c372";
    else if (finalScore >= 60) color = "#f7b731";
    else color = "#fa5252";

    let interval = setInterval(() => {
        current++;
        inner.innerText = current;
        circle.style.background =
            `conic-gradient(${color} ${current * 3.6}deg, #ddd 0deg)`;
        if (current >= finalScore) clearInterval(interval);
    }, 15);

    document.getElementById("pb-content").style.width = data.content + "%";
    document.getElementById("pb-keyword").style.width = data.keyword + "%";
    document.getElementById("pb-tech").style.width = data.technical + "%";
    document.getElementById("pb-onpage").style.width = data.onpage + "%";
    document.getElementById("pb-links").style.width = data.links + "%";

    let auditHTML = "";
    data.audit.split("\n").forEach(line => {
        if (line.trim() !== "") {
            auditHTML += `<div class="audit-entry">${line}</div>`;
        }
    });
    document.getElementById("auditBox").innerHTML = auditHTML;

    let tipsHTML = "";
    data.tips.split("\n").forEach(tip => {
        if (tip.trim() !== "") {
            tipsHTML += `<li>${tip.replace("‚Ä¢ ", "")}</li>`;
        }
    });
    document.getElementById("tipsBox").innerHTML = tipsHTML;

    /* STORE JSON FOR PDF EXPORT */
    window.lastAnalysisPayload = data;
    window.lastAnalysisPayload.url = url;
    window.lastAnalysisPayload.keyword = keyword;
    window.lastAnalysisPayload.competitor = competitor;

    document.getElementById("pdfBtn").style.display = "block";
}

/* ===================== PDF BUTTON ===================== */
document.getElementById("pdfBtn").onclick = async function () {

    const isPro = {{ "true" if subscribed else "false" }};

    if (!isPro) {
        document.getElementById("upgradeModalBG").style.display = "flex";
        return;
    }

    const data = window.lastAnalysisPayload;
    if (!data) return alert("Run an analysis first.");

    const resp = await fetch("/export-pdf", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
    });

    if (resp.status === 403) {
        document.getElementById("upgradeModalBG").style.display = "flex";
        return;
    }

    const blob = await resp.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "seo_report.pdf";
    a.click();
    URL.revokeObjectURL(url);
};
</script>

{% endblock %}
